;; p99-patcher - A patcher/launcher for the project1999.org Everquest server
;; Copyright (C) 2013 Matthew Carter
;;
;; This program is free software: you can redistribute it and/or modify
;; it under the terms of the GNU Affero General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or
;; (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU Affero General Public License for more details.
;;
;; You should have received a copy of the GNU Affero General Public License
;; along with this program.  If not, see <http://www.gnu.org/licenses/>.

;;;; p99-patcher.lisp

(in-package #:p99-patcher)

;;; "p99-patcher" goes here. Hacks and glory await!

(eval-when (:compile-toplevel :load-toplevel :execute)
  (setf (cl-who:html-mode) :html5))

(defparameter *junk-sample-setting* "" "Just a placeholder setting")
(defparameter *toot* nil "The webserver instance")
(defparameter *eq-path* nil "The EQ install path")
(defparameter *percent-done* 0 "The EQ % done on a scan")
(defparameter *download-percent-done* 1 "The % done on a download")
(defparameter *status* "Waiting for you to scan..." "The EQ status")

(defun md5-as-string (md5-vector)
  "Convert an md5-vector, as generated by md5sum-file or md5sum-string
into a plain string for easy comparison"
  (string-downcase
   (format nil "铂О" (coerce md5-vector 'list))))

(defun md5-check-file (file expected-md5)
  "Check a file to see if it matches an expected md5"
  (let ((md5 (if (probe-file file)
                 (md5-as-string (md5sum-file file))
                 "invalid-md5"))
        (expected-md5 (string-downcase expected-md5)))
    (equal md5 expected-md5)))

(defun is-gz? (file-path)
  "Check if the file is a gz or not"
  (equal "gz" (pathname-type file-path)))

(defun is-zip? (file-path)
  "Check if the file is a zip or not"
  (equal "zip" (pathname-type file-path)))

(defun gunzip (file-path)
  "Decompress a gz file"
  (setf *status* "Decompressing and installing...")
  (gzip-stream:gunzip
   file-path
   (subseq file-path 0 (- (length file-path) 3)))
  (delete-file file-path))

(defun unzip (file-path)
  "Decompress a zip file"
  (setf *status* "Decompressing and installing...")
  (zip:unzip file-path *eq-path* :if-exists :supersede)
  (delete-file file-path))

(defun time-extension ()
  "Decode universal time into something more readable"
  (multiple-value-bind
        (sec min hour day mo year)
      (get-decoded-time)
    (format nil "2,'0d2,'0d2,'0d2,'0d2,'0d2,'0d"
            year mo day hour min sec)))

(defun backup-file (file-path)
  "Make a backup of a file for future use"
  (let ((current-path (merge-pathnames file-path *eq-path*))
        (backup-path (merge-pathnames
                      (format nil "a.a" file-path (time-extension))
                      (get-path "backups/"))))
    (when (probe-file current-path)
      (ensure-directories-exist backup-path)
      (copy-file current-path backup-path))))

(defun save-with-extension (save-as uri)
  "If the uri download has a different extension than our
locally stored file, we want to make sure to save it with
the uri file name, not our save as default"
  (if (or (equal (pathname-type save-as)
                 (pathname-type uri))
          (not (pathname-type uri)))
      save-as
      (format nil "a.a" save-as (pathname-type uri))))

(defun download-file (save-as uri &optional uri-size)
  "Download a file and save it to the proper location"
  (let ((input (ignore-errors (http-request
                               uri
                               :want-stream t
                               :connection-timeout 2))))
    (when input ;; Only save the new file when we have input
      (let ((save-as (save-with-extension save-as uri))
            (bytes-done 0)
            (uri-size (or uri-size 1)))
        (ensure-directories-exist save-as)
        (with-open-file (file save-as
                              :direction :output
                              :if-does-not-exist :create
                              :if-exists :supersede
                              :element-type '(unsigned-byte 8))
          (loop for byte = (read-byte input nil 'eof)
             until (eq byte 'eof)
             do (progn
                  (setf *download-percent-done* (/ (incf bytes-done) uri-size))
                  (write-byte byte file)))
          (close input))
        (cond ((is-gz? uri) (gunzip save-as))
              ((is-zip? uri) (unzip save-as)))))))

(defun get-eq-path ()
  "Attempt to find common EQ paths, if they exist then return"
  (or (probe-file "C:/Program Files/Sony/EverQuest/")
      (probe-file "C:/Program Files (x86)/Sony/EverQuest/")
      (probe-file "/.wine/drive_c/Program Files/Sony/EverQuest/")))

(defun get-path (path)
  "Check the default path we are in for portability - if the development
file path exists, use that, otherwise use the relative path to exe run"
  (or (probe-file (merge-pathnames (format nil "src/lisp/p99-patcher/a" path)))
      (probe-file (merge-pathnames path))))

(defun get-json-file ()
  "Pull the remote JSON file from the server that provides it"
  (download-file (merge-pathnames (get-path "www/")
                                  "p99-patcher.json")
                 "http://ahungry.com/p99-patcher.json"))

(defun read-json-file (json-file)
  "Read the json file into the associated alists"
  (format nil "狺鏖翳镳孱骈戾牦镱骈戾祜镳骘扉铄蝈徜扉铄铋у镦躅糸ㄥ扉铄у镦泔祆邈篝蜷铉趄轫扉铄┅┅ㄤ彐躅疳蝮瀛牦镱骈戾牦镱篝蜷铉⑿狎箦秕翳篝蜷铉狍铄邃邃鏖翳轭瘐舡骝镯篝蜷铉牦镱牦镱篝蜷铉ㄣ飙牦镱轰邈镤瀛牦镱牦镱┅ㄤ彐躅祜徜筱蝈孱轫徵瀛ī⒚桢汶殒麇犰蝈徜栳鲥祜徜筱蝈孱轫徵矧铒簪痱镡瀛骈戾礤蜱瀛疳翳钺礤㈧镝潴泸邋町牮纰ㄧ弭疳翳Ⅶ鼢轫绡┅┅ㄤ彐躅珏舡祜徜筱蝈孱轫徵ī⑿蹯祜徜筱蝈孱轫徵秕镦翳叛溟蝈泗矧躅戾篌祜徜筱蝈孱轫徵瀛皓戾è轫徵痱镡瀛骈戾礤蜱瀛疳翳钺礤⒁弩秕蜚弩祜徜筱蝈孱牮纰羼疳翳┅┅麒孱轫徵ㄣ镳骈戾轫徵ㄦ矧磲铋狺幄ㄧ弭疳翳Ⅶ鼢轫绡㈧镝潴泸邋町牮纰┅┅祜徜筱蝈孱轫徵瀛皓ㄤ彐躅疳珏轭溴ī⒂栾翳溴驷蹯轭溴麇煦镯疳珏鏖翳梏盱秕麴豸麸篝蜷铉铋吼蝻祜珲洪钿孱舂ㄨ繇ê梏盱ê桢徜ê筱蜷痿后蜚牦犟蹂蝙碑卑伯黹町牦呼疱Ⅳ屮舣赆鲠筱蜷痿ê筱蜷痿后蜚牦磲轭牦呼疱Ⅳ屮舣赆鲠筱蜷痿ê扉铍鸿蝈泱蟑磲轭泱螈呼疱Ⅳ屮舣泱螈候屐Ⅲ豉戾箬邋簪ê怙澌ê溟洪疳翳轭骘ㄦ眙⒄箝铉翳骘祆秣轭轭篝犰溟蝈泗矧间轹殇涧疳翳Ь峒溟鼍ㄥ溟箦趑轭珞扉箴犷蝈篝狎灬躅汨弪麸汨犷珏羼疳翳ê怛⒁屦矧痱镡戾眢麸ê鸿蝈㈨衢祠锖砝徼躅珧泔恝㈨泪桴铉蝙泔恝嗅翥桢痱秭殇邃怡ê鸿蝈㈣趑鸷徼躅珧泔恝㈣趑鸷徼躅珧泔恝┅ê溟洪㈨衢睥ê溟洪㈨弩筢珏⒂翎趱蠛ê轫后蜚轫绡祜徜筱蝈孱牮纰恒灬篌㈧镝潴泸邋睥ê溟洪Ⅶ殇珏趔ê溟洪㈧镝溻狎ê溟洪㈧镝滏殪膦ê溟洪滹黝祜徜疱蜚孱舡滹铄ê溟洪Ⅲ翎趱螈ê溟洪㈧镝漯弪沐铘⒈鞍ア┅ê鸿蝈聃殂氕筱犷恒灬篌⑨簌钽洪Ⅰ蹰汶筱犷⒂汜畀嗅翥轻礤ê鸿蝈痨狴羼恒灬篌⑨簌钽洪痨狴羼⑿灬碰弪氧弩簟┅ê鸿蝈磲痧弪宽狃钺礤芥屐鏖翳遽呼狎珏⑦忪犷擘ê璞⑼狃疱颌┅ê璩⑸钽祯溴翳骘祆秣轭橡糸镱犰盹潴犷麸镬蠛ê轭瘐洪⑨蹉糸镱祜珑弪呼疱汨邈脞秫侯犴⑨蹉糸镱祜珑弪ê灬忮烘矧⑨蹉糸镱祜珑弪⒘桴铉蝙义犰糸礤刘泗轱田珑弪ê箴犷恒灬篌㈨镤溴筱蜷痿轱睥⒘狨泗轱祜珑弪躔祜徜弪镱沐轭篝犰戾箝眇禊豉疱Н祜绉轭玑礤麸徙糸鲠翦轸犷泔铘蜷怩翦秕祜珞麸梏麴函徼躅珧泔懑羼狨泗轱铙┅ê怛ê怛ê怛ê怛┅┅ㄤ彐躅痨狴羼ī⑿灬翳碰弪氧弩玑礤怡轭鲲腴铉翳蝓痱镧蜥汜祆筲屮艉蝓瞽痱镧蜥矧痱镡瀛骈戾礤蜱瀛疳翳钺礤㈠癞箬ㄧ弭疳翳┅换紊躞弪徜犷羼箬麸泔铘蝻叛灬躅汨礤蜱瀛疳翳钺礤㈠耒犴瀹屮澧羼疳翳┅扉篝疳翥桧澧瑚衢铋飑ㄤ彐躅溴戾翦忉洵骈戾ī⒚戾狎秕舣溴戾翦骈戾翳狒泄栳铒躞骘颥怩铒忮骘蝈忉汶轭翳屙躔骘翳躞弪牾篝轭汜箦戾è溴戾翦扉篝Ж⑨蝈钺羼纰⑨蝈钺吲铞轵镱礤铘彭轸翦蝮豇簪㈧狯狍麸蝽羼纰㈩咫趱祜螽羼纰⑽咫趱祜筮蓬鲩蝻铐孱襞黹趑弪螽豇簪┅磲疸狎灬礅溽ㄦ殪濠戾è骈戾疳翳礤蜱瀛疳翳钺礤骈戾羼疳翳┅麒孱痱镡瀛骈戾骈戾疳翳ㄢ徙膈瓠骈戾骈戾ㄤ屐弭瀛骈戾骈戾疳翳┅┅溴戾翦扉篝┅ㄤ彐躅聃殂氕筱犷忉汶躔ī⑶秭弪翳骈戾犷忉汶躔犷翳狒栳鲥轭鲠扉汨邈塍蹴螽澡轶轶铄沐篌狎箝钽箫礤骈戾磲忮痱秭殇邃鲩轲翳狒孱潴躔秭弪黩轸轭磲铢骈戾狒镱沐箦翩篝狒躞⒙徙膈筱犷戾è骈戾扉篝疳蝮瀛牦镱骈戾蝈徜牦镱骈戾ㄧ弭疳翳Ⅶ鼢鸸弓疳翥桢虍牦镱┅┅ㄣ秕铘弪癌磲疸狎灬礅溽ㄦ殪濠箦翩疱蜚孱舡滹铄ǒㄩ钽泔躅翦颟í戾铉翳骈戾扉篝┅┅箦翩篝狒躞ㄦ矧磲铋⒂汜铑轭绾幄ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅┅戾è骈戾疳翳礤蜱瀛疳翳钺礤ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅羼疳翳┅躅戾篌礓淡汨邈氕骈戾骈戾疳翳ㄣ潋ㄡ篌镢恒桢汶篚骈戾┅箦翩篝狒躞ㄦ矧磲铋⒙徙腴铉躔幄ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅┅ㄢ徙膈瓠骈戾ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅┅┅骈戾扉篝┅ㄤ彐躅聃殂氕筱犷滹黝祜徜ī⒁躅驷篝筱犷镱骈戾泔铘衢铄轭翳忉箝牦镱骈戾犷滹黝祜徜犷翳狒滹铒磲翥翳彘汨邈塍蹴螽箦翩篝狒躞⒛秣铎镝筱犷戾è骈戾扉篝疳蝮瀛牦镱骈戾蝈徜牦镱骈戾ㄧ弭疳翳Ⅶ鼢鸸弓疳翥桢虍牦镱┅┅ㄣ秕铘弪癌磲疸狎灬礅溽ㄦ殪濠箦翩疱蜚孱舡滹铄ǒǐ戾铉翳骈戾扉篝ㄩ钽泔躅翦颟í戾铉翳骈戾扉篝┅┅箦翩篝狒躞ㄦ矧磲铋⒂汜铑轭绾幄ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅┅戾è骈戾疳翳礤蜱瀛疳翳钺礤ㄣ潋ㄡ篌镢烘殪孱犴骈戾┅羼疳翳┅躅戾篌礓淡汨邈氕骈戾骈戾疳翳ㄣ潋ㄡ篌镢恒桢汶篚骈戾┅箦翩篝狒躞ㄦ矧磲铋⒛秣铎镝溟铉幄ㄣ潋ㄡ篌镢轰秣铎镝骈戾┅┅ㄤ秣铎镝洵骈戾骈戾疳翳ㄣ潋ㄡ篌镢轰秣铎镝骈戾┅疳蝮瀛轭翦珏ㄣ潋ㄡ篌镢烘殪弩辁骈戾┅宏躅氕犰祜麇舂┅┅骈戾扉篝┅ㄤ彐躅聃殂氕筱犷ī⑿弪骘蝽翳忉汶躔镦犰骈戾犷翳滹黝祜徜镦翳铄镱弩箦翩疱蜚孱舡滹铄癌ㄧ弭牦镱骈戾换絮祆轭翳蝈盹翦牦镱骈戾ㄤ屐弭瀛忉洵骈戾螬换渺遽秕鸸躅骝殄钿禊骈戾聃殂氕筱犷忉汶躔螬换抿遽翦忉汶躔镦黹箜狒汨邃骈戾聃殂氕筱犷滹黝祜徜螬箦翩篝狒躞⒂汜泔眇戾翦ㄣ扉汶徐狴碰弪氧弩簟┅换娘黝祜徜铄骈戾ㄤ彐躅箦舡溴驷蹯舡疳翳钺礤ī⒚镱骈蝽秕箫躜沐怩殪溟蝈泗矧滹弩瞌屮轶雉桢蝼轶牾篝躞沲蝌孱溟蝈泗矧麒孱痱镡瀛骈戾礤蜱瀛疳翳钺礤ＰⅢ蜚扉箴鸸弓疳翥桢虔躞弪栾礤溟颦疳翳钺礤┅箦翩溴驷蹯舡疳翳钺礤溴驷蹯趔礤蜱瀛疳翳钺礤ＰⅢ蜚扉箴鸸弓疳翥桢虔躞弪栾礤溟颦疳翳钺礤┅┅ㄤ彐躅磲轭ī⒂翎螋躔翳祜汜麇怏弪鲥颥滹翳雉桢铄沐篌狎翳轭珞麒孱汜祆邃骝镯麇怏弪鲥弼孱趔筱犷骈戾蟑痨狴弭惝箦舡溴驷蹯舡疳翳钺礤躅戾篌麸雉换郁狎翳麇箦蝣弪箦翩麸雉磲脲轭篝犷沐ц躅汨孱麸雉哄狍徙沐痿矧吼矧创创喉弩筢珏祜绛溴篝轭狒轱铋横沣弩蟓祜绛溴篝轭狒轱铋飑箦翩ㄨ躅汨孱麸雉横沣屦麸颦滹沲礤铘蝻雉麸雉ㄧ弭疳翳Ⅶ鼢┅ㄨ躅汨孱麸雉后翎螋麸雉┅换渝翳溴驷蹯叛疳翳躞弪汜汨犷珏镱犷轭瘐换骘蝽殒铄沐篌狎犷麇鏖祆筢鲥麸骈戾狒箫礤痫轭箦翩羼疳翳ㄧ弭羼疳翳┅换田徜躞弪箦趑轭珞ㄣ躞麸羼疳翳弭悌祜徜礤蜱瀛疳翳钺礤Ⅲ弭糸铉螽扉箴ㄧ弭疳翳┅洪姝滹弩铒舡屮轶铋飑ㄩ羼疳翳痱镧换渝躔翳祜徜筱蝈孱轫徵ㄧ弭祜徜筱蝈孱轫徵濠换腻骈铄翳栳钿戾蝮ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄栾礤乎蜷ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱疳珏轭溴┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄牦乎蜷牦磲轭牦ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣赆鲠筱蜷痿疳珏牦┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄泱乎蜷泱蟑磲轭泱螈ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣泱螈疳珏泱螬ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄痨狴羼乎蜷痨狴羼ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱痨狴羼痱轭⑻狨钽桢玑礤、┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄疱蜚孱舡滹铄乎蜷疱蜚孱舡滹铄ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱ㄦ矧磲铋洧蝻躅í卑ㄦ祜狒疱蜚孱舡滹铄┅┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄篝狒躞乎蜷篝狒躞ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱篝狒躞ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄滹黝祜徜疱蜚孱舡滹铄乎蜷滹黝祜徜疱蜚孱舡滹铄ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱戾è漯蝻躅í卑ㄦ祜狒滹黝祜徜疱蜚孱舡滹铄┅┅麒孱漯卑癌箦翩漯卑癌ㄦ矧磲铋洧漯洎┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄聃殂氕筱犷乎蜷聃殂氕筱犷ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱聃殂氕筱犷痱轭⒘祆骈戾疳翥桢犷躔溽翦洹┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄珏舡磲乎蜷珏舡磲鸠磲瓠钺礤箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱磲瓠珏磲瓠钺礤┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄磲瓠牦乎蜷牦磲甬牦ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣赆鲠筱蜷痿磲瓠牦┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄珏舡磲瓠痨狴弪乎蜷珏舡磲瓠痨狴弪ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱⑨痧扉汜糸镱牦镱ㄣ飙牦镱哄钽镤瀛牦镱麸篝蜷铉磲瓠痨狴弪祜悱牦镱骝殄钿禊┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄珏舡磲瓠骝殄钿乎蜷珏舡磲瓠骝殄钿蟑ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱⑨痧扉汜糸镱牦镱ㄣ飙牦镱哄钽镤瀛牦镱麸篝蜷铉磲瓠骝殄钿蟓祜悌┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄磲瓠簌钽乎蜷磲瓠簌钽ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱磲瓠簌钽┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄磲痧弪乎蜷磲痧弪磲瓠钺礤箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱磲痧弪磲瓠钺礤┅痱镧换屐箦沆狨箦ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄栾礤乎蜷ī箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱⑽叛嗅翳渝趱瓞痨遽箦蝈徜翳遗聊团狒坚栩彐涧梏麴蠛玳翳踱泔懑徼躅珧鸸弓疳翥桢颛捐趑痼函玳翳踱泔懑徼躅珧鸸弓疳翥桢蚣峋犷疳狒翦铘轱麸撂翳轭篝蝓泗轱铙ㄡ祗蝈徜犷躅溴蝮翎钿翳泔眄孱趔换轭箦趑轭珞扉箴┅ㄨ躅汨孱麸雉轰彐轭瀛遽簌栳钿戾躜榄磲瓠蝈沐轹瀛祜乎蜷磲瓠蝈沐轹瀛祜惘钺礤镱濠箦翩ㄨ躅汨孱麸雉恒镱翦铘豉疱Ⅳ屮舣梏盱ㄣ飙牦镱哄钽镤瀛牦镱麸篝蜷铉磲瓠蝈沐轹瀛祜钺礤镱濠┅磲瓠痫瘐灬翦镱瀛钺礤螬舂